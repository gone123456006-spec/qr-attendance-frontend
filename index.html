<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QR Attendance â€” Saamarthya Academy</title>

<!-- ZXing QR scanner -->
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>

<style>
:root{
  --bg:#f6f7fb; --surface:#ffffff; --ink:#1f2a44; --muted:#6b7280; --line:#e6ebf2;
  --primary:#3b5bff; --primary-weak:#e8edff; --ok:#15803d; --warn:#b91c1c;
  --radius-xl:16px; --radius:12px;
  --font: system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--font);font-size:16px;line-height:1.5}
header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
.wrap{max-width:1320px;margin:0 auto;padding:22px 24px}
.header-bar{display:flex;justify-content:space-between;align-items:center;gap:16px}
.brand{display:flex;align-items:center;gap:12px}
h1{margin:0;font-size:24px}
.subtitle{color:var(--muted);font-size:13.5px}
a.btn{display:inline-block;text-decoration:none;padding:10px 16px;border-radius:9999px;font-weight:700;transition:all .2s;border:1px solid transparent}
a.btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
a.btn.primary:hover{background:#2d47cc}
.grid{display:grid;gap:18px;grid-template-columns:1.15fr .85fr}
@media (max-width:1020px){.grid{grid-template-columns:1fr}}
.card{background:var(--surface);border:1px solid var(--line);border-radius:var(--radius-xl);padding:20px}
.card h2{margin:0 0 12px;font-size:19px}
.scan-drop{position:relative;width:100%;aspect-ratio:16/9;border:1px solid var(--line);border-radius:14px;background:#f3f6fc;display:grid;place-items:center}
.qr-placeholder{width:140px;height:140px;border-radius:999px;background:radial-gradient(100% 100% at 30% 20%,#7a8cff 0%,#ff6a6a 100%);display:grid;place-items:center;color:#fff;font-size:48px;font-weight:800}
.scan-drop input[type=file].file-btn{position:absolute;top:50%;left:50%;transform:translate(-50%,62px);background:#fff;border:1px solid var(--line);border-radius:6px;padding:4px 10px;font-weight:700;cursor:pointer}
.scan-active .qr-placeholder,.scan-active .file-btn{display:none}
.scan-active #video{display:block}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
.btn-sm{font-size:14px;padding:8px 12px;min-height:36px}
button{background:#fff;color:var(--ink);border:1px solid var(--line);padding:10px 14px;border-radius:9999px;font-weight:700;cursor:pointer;transition:.15s;min-height:42px}
button:disabled{opacity:.55;cursor:not-allowed}
button.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
button.ghost{background:#fff;color:var(--ink);border-color:var(--line)}
button.ok{background:var(--ok);color:#fff;border-color:var(--ok)}
button.warn{background:var(--warn);color:#fff;border-color:var(--warn)}
.btn-hover-red:hover{border-color:#ef4444;box-shadow:0 0 0 3px rgba(239,68,68,.12)}
button.ghost.btn-hover-red:hover{background:rgba(239,68,68,.06)}
.filterbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:12px}
.filterbar .left,.filterbar .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.select,select,input[type=date]{background:#fff;color:#1f2a44;border:1px solid var(--line);border-radius:9999px;padding:9px 12px;min-height:42px;font-weight:600}
#filtersPanel{display:none;margin-top:10px}
#filtersPanel .left{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.table-wrap{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
table{width:100%;border-collapse:collapse}
thead th{background:var(--primary-weak);color:#23325a;font-weight:700;border-bottom:1px solid var(--line);padding:10px 12px;text-align:left}
td{padding:10px 12px;border-bottom:1px solid var(--line)}
tbody tr:nth-child(even){background:#fafbff}
td.center{text-align:center}
.chip{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid var(--line);background:#f2f4f8;color:#475569}
.chip.ok{background:#dff7ea;border-color:#bfead4;color:var(--ok)}
.chip.warn{background:#ffecec;border-color:#ffc9c9;color:var(--warn)}
.dash-actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:16px}
.btn-danger-lg{background:#ef4444;color:#fff;border:none;padding:12px 18px;border-radius:9999px;font-weight:800;min-height:46px}
.btn-accent-lg{background:#1f7a1f;color:#fff;border:none;padding:12px 18px;border-radius:9999px;font-weight:800;min-height:46px}
@media (max-width:820px){.table-wrap{overflow-x:auto} thead th,tbody td{white-space:nowrap}}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="wrap header-bar">
    <div class="brand">
      <img src="LOGOOO.svg" height="50" width="50" alt="Saamarthya Academy Logo">
      <div>
        <h1>QR Attendance</h1>
        <div class="subtitle">Scan once per day â€” duplicates are blocked automatically</div>
      </div>
    </div>
    <nav>
      <!-- If you renamed it, use qr-generator.html -->
      <a href="qr-generator.html" class="btn primary">QR Generator</a>
    </nav>
  </div>
</header>

<!-- MAIN -->
<main class="wrap" style="margin-top:12px;">
  <div class="grid">
    <section class="card">
      <h2>Scan Student QR Code</h2>
      <div id="scanTile" class="scan-drop">
        <div class="qr-placeholder">ðŸ”²</div>
        <br>
        <input type="file" id="fileInput" accept="image/*" class="file-btn" />
        <video id="video" playsinline style="display:none; width:100%; height:100%; border-radius:14px;"></video>
      </div>

      <div class="controls">
        <button id="startBtn" class="primary btn-sm btn-hover-red">Start Camera</button>
        <button id="stopBtn"  class="ghost   btn-sm btn-hover-red" disabled>Stop Camera</button>
        <label class="row" style="gap:6px; color:var(--muted);">
          <input type="checkbox" id="beep" checked /> Beep + Voice
        </label>
      </div>

      <div class="filterbar">
        <div class="left">
          <button id="toggleFilters" class="ghost btn-hover-red">Filters</button>
        </div>
        <div class="right">
          <button id="downloadCsv" class="ok btn-hover-red">Download Attendance</button>
        </div>
      </div>

      <div id="filtersPanel">
        <div class="left">
          <select id="cameraSelect" class="select" title="Camera"></select>
          <select id="filterClass" class="select">
            <option value="">All Classes</option>
          </select>
          <select id="filterStatus" class="select">
            <option value="">All Status</option>
            <option value="Present">Present</option>
            <option value="Duplicate">Duplicate</option>
          </select>
          <input type="date" id="filterDateFrom" />
          <input type="date" id="filterDateTo" />
        </div>
      </div>

      <div id="lastScanMsg" style="margin-top:6px; color:var(--muted); font-size:13px;"></div>

      <div class="table-wrap" style="margin-top:10px;">
        <table id="logTable" aria-label="Attendance Log">
          <thead>
            <tr>
              <th>#</th><th>Student ID</th><th>Name</th><th>Class</th><th>Status</th><th>Date</th><th>Time</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot><tr id="noRows" style="display:none;"><td colspan="7" class="center" style="color:var(--muted)">No results</td></tr></tfoot>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>Dashboard Overview</h2>
      <div class="table-wrap">
        <table id="dashTable" aria-label="Dashboard by Class">
          <thead>
            <tr>
              <th>Class</th><th>Total Students</th><th>Present Today</th><th>Absent Today</th>
            </tr>
          </thead>
          <tbody id="dashBody"></tbody>
        </table>
      </div>
      <div class="dash-actions">
        <button id="clearToday" class="btn-danger-lg">Clear Todayâ€™s Attendance</button>
        <button id="finalizeAndDownload" class="btn-accent-lg">Finalize Day (Mark Absent) + Download</button>
      </div>
      <div class="subtitle" id="overallSummary" style="margin-top:8px;">Overall â€”</div>
    </section>
  </div>
</main>

<div class="toast" id="toast" style="display:none; position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:999px; font-weight:700;"></div>

<script>
/* ===========================
   API CONFIG (edit if needed)
=========================== */
const API_BASE = "http://localhost:3000";  // change to your server/IP if needed
const API_KEY  = "supersecret123";         // same as Server/.env API_KEY

/* ===========================
   Students DB (OBJECT)
=========================== */
const students = {
  "SAH25009": { name:"Aditya Raj", class:"8",  phone:"6206971640", email:"parent1@gmail.com" },
  "SAH25010": { name:"Shreyansh Kumar", class:"8",  phone:"8340135190", email:"parent2@gmail.com" },
  "SAH25011": { name:"Aayush Kant", class:"8",  phone:"7321852484", email:"Shwetarani62621@gmail.com" },
  "SAH25200": { name:"Shyam Kumar", class:"8",  phone:"7321852484", email:"Shyam123456006@gmail.com" },
  "SAH25201": { name:"Aarav Kumar", class:"8",  phone:"6204020655", email:"Shyamroaster@gmail.com" },



  "SAJ25013": { name:"Kritika Arya", class:"10", phone:"7870454422", email:"parent4@gmail.com" },
  "SAJ25012": { name:"Shweta Kumari", class:"10", phone:"8873238428", email:"parent5@gmail.com" },
  "SAJ25011": { name:"Divyanshu Kumar", class:"10", phone:"8789580780", email:"parent6@gmail.com" },
  "SAJ25016": { name:"Arnav", class:"10", phone:"9934490207", email:"parent7@gmail.com" },
  "SAJ25015": { name:"Dhruv Ranjan", class:"10", phone:"7979709595", email:"parent8@gmail.com" },
  "SAJ25014": { name:"Sonali Kumari", class:"10", phone:"8862991979", email:"dollydevi0108@gmail.com" },



  "SAN25008": { name:"Ashutosh Raj", class:"9",  phone:"9905606885", email:"ajaybhagat1880@gmail.com" },
  "SAN25016": { name:"Satyam Kumar", class:"9",  phone:"9472094162", email:"raybishwambhar851@gmail.com" },
  "SAN25012": { name:"Krish Raj", class:"9",  phone:"9304998868", email:"ajeet74844@gmail.com" },
  "SAN25011": { name:"Manvi", class:"9",  phone:"8989972932", email:"Mukeshkumar180075@gmail.com" },
  "SAN25015": { name:"Bharat Kumar Adarsh", class:"9", phone:"9122609590", email:"parent14@gmail.com" },
  "SAN25010": { name:"Tripti Kumari", class:"9", phone:"8789832449", email:"parent15@gmail.com" },
  "SAN25013": { name:"Anamika", class:"9", phone:"9508400448", email:"Sinha2nitesh@gmail.com" },
  "SAN25014": { name:"Saumya Chauhan", class:"9", phone:"6205053029", email:"Hmvishwajeetkumar2002@gmail.com" },
  "SAN25017": { name:"Kumari Kamya", class:"9", phone:"6204020655", email:"Shyam123456006@gmail.com" },
  "SAN25100": { name:"Vishwajeet Kumar", class:"9", phone:"6204020655", email:"Hmvishwajeetkumar2002@gmail.com" },



  "SAE25045": { name:"Khushi Kumari", class:"11", phone:"8877949381", email:"Hmvishwajeetkumar2002@gmail.com" },
  "SAE25020": { name:"Saloni", class:"11", phone:"6204020655", email:"anjali.kumari@gmail.com" },
  "SAE25037": { name:"Janvi Srivastava", class:"11", phone:"9973320400", email:"anjali.kumari@gmail.com" },
  "SAE25039": { name:"Samiksha Srivastava", class:"11", phone:"765462851",  email:"anjali.kumari@gmail.com" },
  "SAE25038": { name:"Saumya Raj", class:"11", phone:"9570419189", email:"anjali.kumari@gmail.com" },
  "SAE25022": { name:"Naina Kumari", class:"11", phone:"9234764044", email:"anjali.kumari@gmail.com" },
  "SAE25044": { name:"Vishal Athak", class:"11", phone:"7547870991", email:"anjali.kumari@gmail.com" },
  "SAE25040": { name:"Sunny Kumar", class:"11", phone:"7321987684", email:"anjali.kumari@gmail.com" },
  "SAE25030": { name:"Tanish Kumar", class:"11", phone:"9525201135", email:"anjali.kumari@gmail.com" },
  "SAE25026": { name:"Vijay Kumar", class:"11", phone:"7352103550", email:"anjali.kumari@gmail.com" },
  "SAE25028": { name:"Rishi Raj", class:"11", phone:"8757497670", email:"anjali.kumari@gmail.com" },
  "SAE25031": { name:"Aashmit Kumar", class:"11", phone:"6203666094", email:"anjali.kumari@gmail.com" },
  "SAE25029": { name:"Shivam Kumar", class:"11", phone:"9113310468", email:"anjali.kumari@gmail.com" },
  "SAE25019": { name:"Md. Isatehsanullah", class:"11", phone:"6299355373", email:"anjali.kumari@gmail.com" },
  "SAE25036": { name:"Md. Mojahid Hussain", class:"11", phone:"6203245651", email:"anjali.kumari@gmail.com" },
  "SAE25046": { name:"Suhani Kumari", class:"11", phone:"8638261845", email:"anjali.kumari@gmail.com" },
  "SAE25025": { name:"Kumari Shreya", class:"11", phone:"9835475671", email:"anjali.kumari@gmail.com" },
  "SAE25048": { name:"Durga Kumari", class:"11", phone:"9934727967", email:"anjali.kumari@gmail.com" }
};

/* Convert object â†’ array for UI logic */
const studentArr = Object.entries(students).map(([id, s]) => ({ id, ...s }));

/* ===========================
   Storage
=========================== */
const LS_KEY = "sa_qr_attendance_v1";
function loadAttendance(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || []; } catch{ return []; } }
function saveAttendance(rows){ localStorage.setItem(LS_KEY, JSON.stringify(rows)); }

/* ===========================
   Utils
=========================== */
const $ = sel => document.querySelector(sel);
function todayStr(d=new Date()){ return d.toISOString().slice(0,10); }
function showToast(msg){ const t=$("#toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",1500); }

/* Beep + voice */
function playBeep(){
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const o = ctx.createOscillator(); const g = ctx.createGain();
  o.connect(g); g.connect(ctx.destination); o.type="square"; o.frequency.value=880;
  o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.25);
  setTimeout(()=>{o.stop();ctx.close();},260);
}
function speakText(text){ try{ const u=new SpeechSynthesisUtterance(text); u.lang="en-IN"; speechSynthesis.speak(u); }catch{} }

/* ===========================
   State
=========================== */
let logRows = loadAttendance();
const studentMap = new Map(studentArr.map(s => [s.id, s]));
const classes = [...new Set(studentArr.map(s=>s.class))].sort((a,b)=>+a-+b);

/* DOM init */
const cameraSelect = $("#cameraSelect");
const filterClass = $("#filterClass");
classes.forEach(c=>{ const o=document.createElement("option"); o.value=c; o.textContent=`Class ${c}`; filterClass.appendChild(o); });

/* ===========================
   Dashboard
=========================== */
function renderDashboard(){
  const body = $("#dashBody"); body.innerHTML = "";
  const today = todayStr();
  const presentSet = new Set(logRows.filter(r=>r.date===today && r.status==="Present").map(r=>r.id));

  const totals = new Map(classes.map(c=>[c,{total:0,present:0}]));
  studentArr.forEach(s=>{ const t=totals.get(s.class); t.total++; if(presentSet.has(s.id)) t.present++; });

  let total=0, present=0;
  classes.forEach(c=>{
    const {total:tt, present:pp} = totals.get(c);
    const aa = tt - pp;
    total += tt; present += pp;
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>Class ${c}</td><td>${tt}</td><td>${pp}</td><td>${aa}</td>`;
    body.appendChild(tr);
  });

  const absent = total - present;
  $("#overallSummary").textContent = `Overall â€” Total: ${total} | Present: ${present} | Absent: ${absent}`;
}

/* ===========================
   Table + Filters
=========================== */
function getFilters(){ return {
  cls: filterClass.value, status: $("#filterStatus").value,
  from: $("#filterDateFrom").value, to: $("#filterDateTo").value
};}
function passFilters(r,f){
  if(f.cls && r.class !== f.cls) return false;
  if(f.status && r.status !== f.status) return false;
  if(f.from && r.date < f.from) return false;
  if(f.to && r.date > f.to) return false;
  return true;
}
function renderTable(){
  const tb = $("#logTable tbody");
  const no = $("#noRows");
  tb.innerHTML = "";
  const f = getFilters();
  const rows = logRows.filter(r=>passFilters(r,f));
  no.style.display = rows.length ? "none" : "table-row";
  rows.forEach((r,i)=>{
    const tr=document.createElement("tr");
    const chipClass = r.status==="Present" ? "chip ok" : "chip warn";
    tr.innerHTML = `
      <td>${i+1}</td><td>${r.id}</td><td>${r.name}</td>
      <td>${r.class}</td><td><span class="${chipClass}">${r.status}</span></td>
      <td>${r.date}</td><td>${r.time}</td>`;
    tb.appendChild(tr);
  });
}
function refreshUI(){ renderDashboard(); renderTable(); }

/* ===========================
   Backend notify (email parents)
=========================== */
async function notifyParentEmail({ id, name, klass, email, when = new Date() }) {
  try {
    const res = await fetch(`${API_BASE}/api/send-email`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": API_KEY
      },
      body: JSON.stringify({
        studentId: id,
        studentName: name,
        parentEmail: email,
        class: klass,
        timestamp: new Date(when).toISOString()
      })
    });
    const data = await res.json();
    if (!data.ok && !data.dedup) console.warn("Email not sent:", data);
  } catch (e) { console.warn("Notify failed", e); }
}

/* ===========================
   Attendance Logic
=========================== */
function alreadyMarkedToday(id){
  const t=todayStr(); return logRows.some(r=>r.id===id && r.date===t && r.status==="Present");
}
function appendLogEntry(entry){ logRows.unshift(entry); saveAttendance(logRows); refreshUI(); }

function markAttendanceFromId(id){
  const person = studentMap.get(id);
  const now = new Date();
  const entry = { id, name: person?person.name:"(Unknown)", class: person?person.class:"-", date: todayStr(now), time: now.toLocaleTimeString(), status:"Present" };

  if(!person){
    entry.status="Duplicate"; appendLogEntry(entry);
    showToast("Unknown QR / Student not found");
    if($("#beep").checked) playBeep();
    speakText("Unknown QR code scanned");
    return;
  }
  if(alreadyMarkedToday(id)){
    entry.status="Duplicate"; appendLogEntry(entry);
    $("#lastScanMsg").innerHTML = `<span style="color:#f87171">Duplicate scan blocked for ${person.name} (Class ${person.class})</span>`;
    if($("#beep").checked) playBeep();
    speakText(`Duplicate scan for ${person.name}`);
    return;
  }

  // Present case
  appendLogEntry(entry);
  $("#lastScanMsg").innerHTML = `<span style="color:#34d399">Marked Present: ${person.name} (Class ${person.class})</span>`;
  if($("#beep").checked) playBeep();
  speakText(`${person.name} Present`);

  // ðŸ”” notify parent email (only for Present)
  notifyParentEmail({ id, name: person.name, klass: person.class, email: person.email, when: now });
}

/* ===========================
   CSV Export (filtered)
=========================== */
function downloadCSV(){
  const f = getFilters();
  const rows = logRows.filter(r=>passFilters(r,f));
  const header = ["#", "ID", "Name", "Class", "Status", "Date", "Time"];
  const csv = [header.join(",")].concat(
    rows.map((r,i)=>[i+1,r.id,r.name,r.class,r.status,r.date,r.time]
      .map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")))
    .join("\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); 
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download=`attendance_${todayStr()}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ===========================
   Clear Today
=========================== */
function clearToday(){
  const t=todayStr(); logRows = logRows.filter(r=>r.date!==t); saveAttendance(logRows); refreshUI(); showToast("Cleared todayâ€™s attendance");
}

/* ===========================
   FINALIZE DAY + DOWNLOAD FULL LIST
=========================== */
function finalizeDayAndDownload(){
  const t = todayStr();

  // Ensure one row per student for today
  studentArr.forEach(s=>{
    const any = logRows.find(r=>r.id===s.id && r.date===t);
    if(!any){
      logRows.unshift({ id:s.id, name:s.name, class:s.class, status:"Absent", date:t, time:"-" });
    }
  });

  saveAttendance(logRows);
  refreshUI();
  showToast("Day finalized. Unscanned marked Absent.");

  // Build full CSV (all students)
  const header = ["#", "ID", "Name", "Class", "Status", "Date", "Time"];
  const rowsForToday = studentArr.map((s, idx)=>{
    const row = logRows.find(r=>r.id===s.id && r.date===t);
    return [idx+1, s.id, s.name, s.class, row?.status || "Absent", row?.date || t, row?.time || "-"];
  });
  const csv = [header.join(",")]
    .concat(rowsForToday.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")))
    .join("\n");

  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); 
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download=`attendance_FINAL_${t}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ===========================
   ZXing Scanner (camera) with stronger hints
=========================== */
let codeReader=null; let currentDeviceId=null;
async function listCameras(){
  const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
  cameraSelect.innerHTML="";
  devices.forEach((d,i)=>{ const opt=document.createElement("option"); opt.value=d.deviceId; opt.textContent=d.label||`Camera ${i+1}`; cameraSelect.appendChild(opt); });
  if(devices[0]) cameraSelect.value=devices[0].deviceId;
}
async function startScanner(){
  if(codeReader){ await stopScanner(); }

  // Hints: prefer QR + try harder
  const hints = new Map();
  if (ZXing.DecodeHintType && ZXing.BarcodeFormat) {
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [ZXing.BarcodeFormat.QR_CODE]);
    hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
  }
  codeReader = new ZXing.BrowserMultiFormatReader(hints);

  currentDeviceId = cameraSelect.value || undefined;
  document.getElementById("startBtn").disabled=true; 
  document.getElementById("stopBtn").disabled=false;
  try{
    await codeReader.decodeFromVideoDevice(currentDeviceId,"video",(res,err)=>{
      if(res && res.text){ markAttendanceFromId(res.text.trim()); }
    });
    setScanActive(true);
    showToast("Camera started");
  }catch(e){
    console.error(e); showToast("Could not start camera");
    document.getElementById("startBtn").disabled=false; 
    document.getElementById("stopBtn").disabled=true;
    setScanActive(false);
  }
}
async function stopScanner(){
  if(codeReader){ await codeReader.reset(); codeReader=null; }
  document.getElementById("startBtn").disabled=false; 
  document.getElementById("stopBtn").disabled=true;
  setScanActive(false);
  showToast("Camera stopped");
}

/* Scan-from-Image */
const fileInput = document.getElementById('fileInput');
fileInput.addEventListener('change', async (e) => {
  const file = e.target.files && e.target.files[0];
  if (!file) return;
  const url = URL.createObjectURL(file);
  try {
    const qrReader = new ZXing.BrowserQRCodeReader();
    // TRY_HARDER for still images too
    const hints = new Map();
    if (ZXing.DecodeHintType && ZXing.BarcodeFormat) {
      hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [ZXing.BarcodeFormat.QR_CODE]);
      hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
      qrReader.defaultOptions = { hints };
    }
    const result = await qrReader.decodeFromImageUrl(url);
    if (result && result.text) { markAttendanceFromId(result.text.trim()); showToast("Scanned from image"); }
    else { showToast("No QR found in image"); }
  } catch (err) {
    console.error(err); showToast("Could not read QR from image");
  } finally {
    fileInput.value = ""; URL.revokeObjectURL(url);
  }
});

/* Filters toggle */
document.getElementById("toggleFilters").addEventListener("click", ()=>{
  const p = document.getElementById("filtersPanel");
  p.style.display = p.style.display === "block" ? "none" : "block";
});

/* Tile visual state */
const scanTile = document.getElementById("scanTile");
function setScanActive(active){
  const video = document.getElementById("video");
  if(active){ scanTile.classList.add("scan-active"); video.style.display="block"; }
  else{ scanTile.classList.remove("scan-active"); video.style.display="none"; }
}

/* Buttons */
document.getElementById("startBtn").addEventListener("click", startScanner);
document.getElementById("stopBtn").addEventListener("click", stopScanner);
document.getElementById("downloadCsv").addEventListener("click", downloadCSV);
document.getElementById("clearToday").addEventListener("click", clearToday);
document.getElementById("finalizeAndDownload").addEventListener("click", finalizeDayAndDownload);

/* Filters */
["filterClass","filterStatus","filterDateFrom","filterDateTo"].forEach(id =>
  document.getElementById(id).addEventListener("input", renderTable)
);

/* Camera hot-switch */
cameraSelect.addEventListener("change", ()=>{ if(codeReader){ startScanner(); } });

/* Init */
(async function init(){
  refreshUI();
  try{ await listCameras(); } catch{}
})();
</script>
</body>
</html>
